# Azure API Management Configuration

This directory contains configuration files for Azure API Management as an alternative to Apigee.

## Structure

```
azure-api-management/
├── apis/
│   ├── external-api/
│   │   └── openapi.json          # OpenAPI spec for external API
│   └── internal-api/
│       └── openapi.json          # OpenAPI spec for internal API
├── policies/
│   ├── external-api/
│   │   └── validate-jwt-external.xml
│   └── internal-api/
│       └── validate-jwt-internal.xml
└── README.md
```

## Deployment

### Using Azure CLI

```bash
# Create API Management instance
az apim create \
  --resource-group rg-csom-platform-prod \
  --name apim-csom-platform-prod \
  --location westeurope \
  --publisher-email admin@company.com \
  --publisher-name "CSOM Platform" \
  --sku-name Developer \
  --sku-capacity 1

# Import external API
az apim api import \
  --resource-group rg-csom-platform-prod \
  --service-name apim-csom-platform-prod \
  --api-id external-api \
  --path external-api/v1 \
  --specification-format OpenApi \
  --specification-path apis/external-api/openapi.json

# Apply JWT validation policy
az apim api policy set \
  --resource-group rg-csom-platform-prod \
  --service-name apim-csom-platform-prod \
  --api-id external-api \
  --policy-format xml \
  --value @policies/external-api/validate-jwt-external.xml
```

### Using Bicep/ARM Templates

See `infrastructure/bicep/api-management.bicep` for infrastructure as code deployment.

## Configuration

### External API
- **Base Path**: `/external-api/v1`
- **Authentication**: Entra External ID JWT
- **Rate Limiting**: 1000 requests/minute
- **CORS**: Enabled for external frontend domain

### Internal API
- **Base Path**: `/internal-api/v1`
- **Authentication**: Entra ID JWT
- **Rate Limiting**: 5000 requests/minute
- **IP Whitelisting**: Enabled for admin endpoints

## Backend Configuration

Backend services are configured to point to AKS internal service endpoints:
- Order Service: `http://order-service:80`
- Product Service: `http://product-service:80`
- Customer Service: `http://customer-service:80`
- etc.

## OpenAPI Import

APIs can be imported from OpenAPI specifications generated by Spring Boot services:
1. Generate OpenAPI spec from service: `GET /v3/api-docs`
2. Import to Azure API Management
3. Configure backend to point to AKS service
4. Apply policies (JWT validation, rate limiting, etc.)

