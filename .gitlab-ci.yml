stages:
  - build
  - test
  - security-scan
  - build-images
  - deploy-dev
  - integration-tests
  - deploy-staging
  - e2e-tests
  - deploy-production

variables:
  ACR_NAME: acrcsomplatform
  AKS_RESOURCE_GROUP: rg-csom-platform-prod
  AKS_CLUSTER_NAME: aks-csom-platform-prod
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build stage for backend services
build-backend:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd backend/order-service
    - mvn clean compile
  only:
    - merge_requests
    - main
    - develop

# Test stage
test-backend:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd backend/order-service
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    reports:
      junit: backend/order-service/target/surefire-reports/TEST-*.xml
  only:
    - merge_requests
    - main
    - develop

# Security scan
security-scan:
  stage: security-scan
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs --severity HIGH,CRITICAL --exit-code 1 backend/
  allow_failure: true
  only:
    - merge_requests
    - main

# Build Docker images
build-docker-images:
  stage: build-images
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login $ACR_NAME.azurecr.io -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET
  script:
    - cd backend/order-service
    - docker build -t $ACR_NAME.azurecr.io/order-service:$CI_COMMIT_SHORT_SHA .
    - docker build -t $ACR_NAME.azurecr.io/order-service:latest .
    - docker push $ACR_NAME.azurecr.io/order-service:$CI_COMMIT_SHORT_SHA
    - docker push $ACR_NAME.azurecr.io/order-service:latest
  only:
    - main
    - develop

# Deploy to Dev
deploy-dev:
  stage: deploy-dev
  image: mcr.microsoft.com/azure-cli:latest
  before_script:
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME
  script:
    - kubectl set image deployment/order-service order-service=$ACR_NAME.azurecr.io/order-service:$CI_COMMIT_SHORT_SHA -n dev
    - kubectl rollout status deployment/order-service -n dev
  environment:
    name: dev
    url: https://dev-api.example.com
  only:
    - develop

# Integration tests
integration-tests:
  stage: integration-tests
  image: maven:3.9-eclipse-temurin-17
  script:
    - cd backend/order-service
    - mvn verify -Pintegration-tests
  dependencies:
    - deploy-dev
  only:
    - develop
    - main

# Deploy to Staging
deploy-staging:
  stage: deploy-staging
  image: mcr.microsoft.com/azure-cli:latest
  before_script:
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME
  script:
    - kubectl set image deployment/order-service order-service=$ACR_NAME.azurecr.io/order-service:$CI_COMMIT_SHORT_SHA -n staging
    - kubectl rollout status deployment/order-service -n staging
  environment:
    name: staging
    url: https://staging-api.example.com
  only:
    - main

# E2E tests
e2e-tests:
  stage: e2e-tests
  image: node:20
  script:
    - cd frontend/shell
    - npm install
    - npm run test:e2e
  dependencies:
    - deploy-staging
  only:
    - main

# Deploy to Production (with manual approval)
deploy-production:
  stage: deploy-production
  image: mcr.microsoft.com/azure-cli:latest
  before_script:
    - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az aks get-credentials --resource-group $AKS_RESOURCE_GROUP --name $AKS_CLUSTER_NAME
  script:
    - kubectl set image deployment/order-service order-service=$ACR_NAME.azurecr.io/order-service:$CI_COMMIT_SHORT_SHA -n production
    - kubectl rollout status deployment/order-service -n production
  environment:
    name: production
    url: https://api.example.com
  when: manual
  only:
    - main

